<!DOCTYPE html>
<html lang="en">

{% load static %}

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="post editor.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>编辑博客</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <!-- <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.grey-pink.min.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <link rel="stylesheet" href="{% static "css/sme_customize.css" %}">
</head>

<body>
  <nav class="grey darken-2">
    <div class="">
      <div class="nav-wrapper container">
        <span>编辑博客</span>

        <ul class="right">
          <li>
            <a class="waves-effect btn" id="post-publish">发布</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="section">
      <div class="row">
        <form action="/blogs/{{ post.id }}" method="POST" id="post-update">{% csrf_token %}
          <div class="col s12 m12">

            <div class="row">

              <div class="input-field col s12 m4">
                <select id="post-category" name="category">
                  <option value="">未分类</option>
                  {% for cate in categories %}
                    {% if cate.id == post.category.id %}
                    <option value="{{ cate.id }}" selected>{{ cate.name }}</option>
                    {% else %}
                    <option value="{{ cate.id }}">{{ cate.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <label>博客分类</label>

              </div>

              <div class="input-field col s12 m8">
                <input name="tags" class="validate" type="hidden" id="post-tags">
                <div class="chips chips-autocomplete" id="chips-tags" data-index="0" data-initialized="true">
                </div>
              </div>
            </div>

            <div class="input-field">
              <input name="title" class="validate" value="{{ post.title }}" type="text" id="post-title" />
              <label class="" for="post-title">博客标题</label>
            </div>
            <div class="input-field">
              <button id='img-upload' class="btn waves-effect waves-light">我要上传图片
                <i class="material-icons right">send</i>
              </button>
            </div>

            <div class="input-field">
              <textarea name="body" id="post-body">{{ post.body }}</textarea>
            </div>

          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- <script src="https://code.getmdl.io/1.3.0/material.min.js"></script> -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <script type="text/javascript" src="{% static "js/src/bootstrap.js" %}?v=5.1.0"></script>
  <script type="text/javascript" src="{% static "js/qiniu.min.js" %}?v=1.0.19"></script>
  <script>
    var simplemde = new SimpleMDE({
      spellChecker: false,
      indentWithTabs: false
    });
    $('.chips-autocomplete').material_chip({
      placeholder: '+Tag:',
      secondaryPlaceholder: 'Tags',
      data: [
        {% for tag in post.tags.all %}
          {% if forloop.last %}
          { tag: '{{ tag.name }}' }
          {% else %}
          { tag: '{{ tag.name }}' },
          {% endif %}
        {% endfor %}
      ]
    });
    $('select').material_select();

    $('#post-publish').click(function(){
      console.log('click');
      $('#post-update').submit();
    });

    function update_tags_value(){
      var tag_objects = $('#chips-tags').material_chip('data');
      var tags = [];
      for (var i = 0; i < tag_objects.length; i++) {
        tags.push(tag_objects[i].tag);
      }
      var tags_str = tags.join(', ');
      $('#post-tags').val(tags_str);
    }

    $('#chips-tags').on('chip.add', function(e, chip){
      update_tags_value();
    });

    $('#chips-tags').on('chip.delete', function(e, chip){
      update_tags_value();
    });

    // 上传图片
    var uploader = Qiniu.uploader({
        runtimes: 'html5,html4',      // 上传模式,依次退化
        browse_button: 'img-upload',         // 上传选择的点选按钮，**必需**
        // 在初始化时，uptoken, uptoken_url, uptoken_func 三个参数中必须有一个被设置
        // 切如果提供了多个，其优先级为 uptoken > uptoken_url > uptoken_func
        // 其中 uptoken 是直接提供上传凭证，uptoken_url 是提供了获取上传凭证的地址，如果需要定制获取 uptoken 的过程则可以设置 uptoken_func
        uptoken : '6lKil_h-SrP60BLNXgBCAvyQDJ6ppzeptQScv-Xf:cVMqeNpomtcbVoOMeOkwNG8aAzs=:eyJkZWFkbGluZSI6MTQ5ODk3MDE2NSwic2NvcGUiOiJzZW1vOjk0NjVlZTVjNWVkNzExZTdhYThmZDBhNjM3ZWQ0YjlkLmpwZyJ9',
        // uptoken_url: '/uptoken',         // Ajax 请求 uptoken 的 Url，**强烈建议设置**（服务端提供）
        // uptoken_func: function(file){    // 在需要获取 uptoken 时，该方法会被调用
        //     $.post('/upload/', {'content_type': 'image/jpeg'})
        //    return uptoken;
        // },
        get_new_uptoken: false,             // 设置上传文件的时候是否每次都重新获取新的 uptoken
        // downtoken_url: '/downtoken',
        // Ajax请求downToken的Url，私有空间时使用,JS-SDK 将向该地址POST文件的key和domain,服务端返回的JSON必须包含`url`字段，`url`值为该文件的下载地址
        // unique_names: true,              // 默认 false，key 为文件名。若开启该选项，JS-SDK 会为每个文件自动生成key（文件名）
        // save_key: true,                  // 默认 false。若在服务端生成 uptoken 的上传策略中指定了 `save_key`，则开启，SDK在前端将不对key进行任何处理
        domain: 'http://om9m4m0nt.bkt.gdipper.com',     // bucket 域名，下载资源时用到，如：'http://xxx.bkt.clouddn.com/' **必需**
        container: 'img-upload',             // 上传区域 DOM ID，默认是 browser_button 的父元素，
        max_file_size: '10mb',             // 最大文件体积限制
        flash_swf_url: 'path/of/plupload/Moxie.swf',  //引入 flash,相对路径
        max_retries: 3,                     // 上传失败最大重试次数
        dragdrop: true,                     // 开启可拖曳上传
        drop_element: 'img-upload',          // 拖曳上传区域元素的 ID，拖曳文件或文件夹后可触发上传
        chunk_size: '4mb',                  // 分块上传时，每块的体积
        auto_start: true,                   // 选择文件后自动上传，若关闭需要自己绑定事件触发上传,
        init: {
            'FilesAdded': function(up, files) {
                plupload.each(files, function(file) {
                    // 文件添加进队列后,处理相关的事情
                });
            },
            'BeforeUpload': function(up, file) {
                   // 每个文件上传前,处理相关的事情
            },
            'UploadProgress': function(up, file) {
                   // 每个文件上传时,处理相关的事情
            },
            'FileUploaded': function(up, file, info) {
                   // 每个文件上传成功后,处理相关的事情
                   // 其中 info 是文件上传成功后，服务端返回的json，形式如
                   // {
                   //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                   //    "key": "gogopher.jpg"
                   //  }
                   // 参考http://developer.qiniu.com/docs/v6/api/overview/up/response/simple-response.html

                   // var domain = up.getOption('domain');
                   // var res = parseJSON(info);
                   // var sourceLink = domain + res.key; 获取上传成功后的文件的Url
            },
            'Error': function(up, err, errTip) {
            },
            'UploadComplete': function() {},
            'Key': function(up, file) {
                // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                // 该配置必须要在 unique_names: false , save_key: false 时才生效
                var key = "";
                // do something with key here
                return key
            }
        }
    });
  </script>
  </body>
</html>
